<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments/header :: head('Home Page')"></head>

<body class="d-flex flex-column min-vh-100">
<header th:replace="fragments/header :: navbar"></header>

<main class="container mt-4 flex-grow-1">
    <h1>Welcome to the Event Management System</h1>
    <p>Find, create, and manage your events easily.</p>

    <!-- Move "Create Event" Button Here for Better Visibility -->
    <div class="d-flex justify-content-end mb-3">
        <a class="btn btn-primary btn-lg" th:href="@{/events/create}">+ Create Event</a>
    </div>

    <div class="row">
        <div class="col-md-12">
            <h2>Upcoming Events</h2>
            <table class="table table-bordered">
                <thead class="table-dark">
                <tr>
                    <th>Event Name</th>
                    <th>Organizer</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Location</th>
                    <th>Available Places</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="event : ${events}">
                    <td>
                        <a th:href="@{/events/{id}(id=${event.id})}" th:text="${event.name}"></a>
                    </td>
                    <td th:text="${event.organizer.username}"></td>
                    <td th:text="${#dates.format(event.startDate, 'dd/MM/yyyy HH:mm')}"></td>
                    <td th:text="${#dates.format(event.endDate, 'dd/MM/yyyy HH:mm')}"></td>
                    <td th:text="${event.place.name}"></td>
                    <td th:text="${event.maxParticipants - event.participants.size()}"></td>
                    <td>
                        <!-- Check if user is authenticated -->
                        <div th:if="${#authorization.expression('isAuthenticated()')}">
                            <!-- If user is the organizer, show Edit & Delete, hide Join -->
                            <div th:if="${#authentication.principal.username == event.organizer.username}">
                                <a class="btn btn-warning" th:href="@{/events/edit/{id}(id=${event.id})}">Edit</a>
                                <a class="btn btn-danger" th:href="@{/events/delete/{id}(id=${event.id})}">Delete</a>
                            </div>

                            <!-- Show Join button only if user is NOT the organizer and event is not full -->
                            <a th:if="${#authentication.principal.username != event.organizer.username && (event.maxParticipants - event.participants.size()) > 0}"
                               class="btn btn-success"
                               th:href="@{/events/join/{id}(id=${event.id})}">
                                Join
                            </a>
                        </div>

                        <!-- If user is not authenticated, just show availability -->
                        <span th:if="${not #authorization.expression('isAuthenticated()') && (event.maxParticipants - event.participants.size()) > 0}" class="text-info">
                            Available
                        </span>

                        <span th:if="${(event.maxParticipants - event.participants.size()) <= 0}" class="text-danger">
                            Full
                        </span>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</main>

<footer th:replace="fragments/footer :: footer"></footer>
</body>
</html>